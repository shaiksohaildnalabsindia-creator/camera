<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>POD Upload</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input, button { font-size: 16px; margin: 5px 0; }
    #preview { margin-top: 10px; max-width: 300px; display: none; }
  </style>
</head>
<body>
  <h2>Upload POD Image</h2>

  <label for="trackingSelect">Select Tracking Number:</label><br>
  <select id="trackingSelect">
    <option value="">Loading...</option>
  </select>

  <br><br>

  <label for="cameraInput">Select Image:</label><br>
  <input type="file" id="cameraInput" accept="image/*" capture="environment">
  <img id="preview" src="#" alt="Image Preview">

  <br><br>
  <button id="uploadBtn">Upload</button>

  <p id="status"></p>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzK6L1gkFT8tGV02tKtEMkaMZlkMwMLIK5_PLlKnYTXlKsthvkrZdkJlOBg3XinIt_9tQ/exec";

    const select = document.getElementById("trackingSelect");
    const fileInput = document.getElementById("cameraInput");
    const preview = document.getElementById("preview");
    const status = document.getElementById("status");
    const uploadBtn = document.getElementById("uploadBtn");

    // Load today's tracking numbers
    fetch(WEB_APP_URL)
      .then(r => r.json())
      .then(data => {
        select.innerHTML = "";
        const filtered = data.filter(x => x && x !== "Unknown");

        if (filtered.length === 0) {
          select.innerHTML = '<option value="">No tracking numbers today</option>';
        } else {
          select.innerHTML = '<option value="">Select Tracking Number</option>';
          filtered.forEach(tracking => {
            const option = document.createElement("option");
            option.value = tracking;
            option.textContent = tracking;
            select.appendChild(option);
          });
        }
      })
      .catch(err => {
        console.error(err);
        select.innerHTML = '<option value="">Error loading tracking numbers</option>';
      });

    // Show image preview
    fileInput.addEventListener("change", () => {
      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(fileInput.files[0]);
      }
    });

    // Upload function
    uploadBtn.addEventListener("click", () => {
      const tracking = select.value;
      if (!tracking) return alert("Select a tracking number");
      if (!fileInput.files[0]) return alert("Select an image");

      status.textContent = "Uploading...";

      const reader = new FileReader();
      reader.onload = function(e) {
        fetch(WEB_APP_URL, {
          method: "POST",
          body: new URLSearchParams({
            image: e.target.result,
            tracking: tracking
          })
        })
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            status.textContent = "Upload successful! File URL: " + res.url;
          } else if (res.error) {
            status.textContent = "Error: " + res.error;
          }
        })
        .catch(err => {
          console.error(err);
          status.textContent = "Upload failed.";
        });
      };
      reader.readAsDataURL(fileInput.files[0]);
    });
  </script>
</body>
</html>
