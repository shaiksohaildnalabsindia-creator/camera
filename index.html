<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>POD Upload</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 400px; }
    select, input, button { display: block; width: 100%; margin-bottom: 15px; padding: 8px; }
    img { max-width: 100%; margin-top: 10px; display: none; }
  </style>
</head>
<body>
  <h2>POD Upload</h2>

  <label for="trackingSelect">Select Tracking Number</label>
  <select id="trackingSelect">
    <option value="">Loading...</option>
  </select>

  <label for="cameraInput">Take or select photo</label>
  <input type="file" id="cameraInput" accept="image/*" capture="environment">

  <button id="uploadBtn">Upload</button>

  <img id="preview" alt="Image Preview">

  <p id="status"></p>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzusteXh6aMr8IMD_3zpiSogPvXpDEnldNRTFmp6S2Lq5qBbzP2x75e5EMveZ3ancJFeg/exec";

    const select = document.getElementById("trackingSelect");
    const fileInput = document.getElementById("cameraInput");
    const preview = document.getElementById("preview");
    const status = document.getElementById("status");
    const uploadBtn = document.getElementById("uploadBtn");

    // Load today's tracking numbers
    fetch(WEB_APP_URL)
      .then(r => r.json())
      .then(data => {
        select.innerHTML = '<option value="">Select Tracking Number</option>';
        if (data.length === 0) {
          select.innerHTML = '<option value="">No tracking numbers today</option>';
        } else {
          data.forEach(tracking => {
            const option = document.createElement("option");
            option.value = tracking;
            option.textContent = tracking;
            select.appendChild(option);
          });
        }
      })
      .catch(err => {
        console.error(err);
        select.innerHTML = '<option value="">Error loading tracking numbers</option>';
      });

    // Show preview when file selected
    fileInput.addEventListener("change", () => {
      if (fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          preview.src = e.target.result;
          preview.style.display = "block";
        };
        reader.readAsDataURL(fileInput.files[0]);
      }
    });

    // Upload function
    uploadBtn.addEventListener("click", () => {
      const tracking = select.value;
      if (!tracking) return alert("Please select a tracking number.");
      if (!fileInput.files[0]) return alert("Please select an image.");

      uploadBtn.disabled = true;
      status.textContent = "Uploading...";

      const reader = new FileReader();
      reader.onload = e => {
        const formData = new URLSearchParams();
        formData.append("tracking", tracking);
        formData.append("image", e.target.result);

        fetch(WEB_APP_URL, {
          method: "POST",
          body: formData
        })
        .then(r => r.text())
        .then(msg => {
          status.textContent = msg;
          if (msg.includes("success")) {
            preview.style.display = "none";
            fileInput.value = "";
          }
        })
        .catch(err => {
          console.error(err);
          status.textContent = "Error uploading image.";
        })
        .finally(() => {
          uploadBtn.disabled = false;
        });
      };
      reader.readAsDataURL(fileInput.files[0]);
    });
  </script>
</body>
</html>
